# Ghost in the VSC - テストガイド

このガイドでは、拡張機能のテスト方法を説明します。

## 📋 前提条件

- Node.js (v18以上)
- VS Code (v1.85.0以上)
- TypeScriptの基礎知識

## 🚀 セットアップ

### 1. 依存関係のインストール

```bash
npm install
```

### 2. TypeScriptのコンパイル

```bash
npm run compile
```

または、ウォッチモードで自動コンパイル：

```bash
npm run watch
```

## 🧪 手動テスト手順

### テスト1: 基本的なゴースト表示

**目的**: エディタ内の関数名でゴーストが表示されることを確認

**手順**:
1. F5キーを押して拡張機能開発ホストを起動
2. 新しいウィンドウで、適当なJavaScript/TypeScriptファイルを開く
3. テストファイルを作成（例: `test.js`）:

```javascript
function myTestFunction() {
    console.log('Hello, Ghost!');
}

const myVariable = 42;

class MyClass {
    myMethod() {
        return 'test';
    }
}

myTestFunction();
```

4. `myTestFunction`の上（関数名の中）にカーソルを置く
5. **期待される結果**:
   - 1行上に赤い点（🔴）が4つ（四隅）表示される
   - 点は小さくて控えめ（デフォルト4px）

**デバッグ**:
- 何も表示されない場合:
  - `Ctrl+Shift+G`（Macは`Cmd+Shift+G`）で有効/無効を切り替えてみる
  - 開発者コンソール（`Ctrl+Shift+I`）でエラーを確認
  - `console.log`でデバッグ情報を出力

---

### テスト2: ホバーでガイド表示

**目的**: 赤い点にホバーするとガイドが表示されることを確認

**手順**:
1. テスト1の状態から続行
2. カーソルを`myTestFunction`の上に置いたまま
3. マウスを1行上の赤い点の近くに移動
4. **期待される結果**:
   - 赤い点が黄色（🟡）に変化
   - 点が少し大きくなる（5px）
   - 透明な背景が薄く表示される
   - 200ms後にガイドパレットが表示される

5. ガイドパレットの内容を確認:
```
┌─────────────────────────┐
│ [function] myTestFunction│
│                          │
│ D  定義へジャンプ         │
│ R  参照を表示            │
│ H  呼び出し階層          │
│ N  名前を変更            │
│ C  コメントを追加         │
│ T  テストを生成          │
└─────────────────────────┘
```

**デバッグ**:
- ガイドが表示されない:
  - `hoverDelay`設定を確認（デフォルト200ms）
  - Webviewが正しく初期化されているか確認
  - ブラウザの開発者ツールでWebviewを検査

---

### テスト3: キーボードショートカット実行

**目的**: キーを押してショートカットが実行されることを確認

**手順**:
1. テスト2の状態から続行（ガイドパレットが表示されている）
2. キーボードで`D`キーを押す
3. **期待される結果**:
   - 「定義へジャンプ」が実行される（F12と同じ動作）
   - 関数定義の位置にカーソルが移動
   - 通知メッセージが表示: "ショートカット実行: D (myTestFunction)"
   - ガイドパレットが非表示になる

4. 他のキーも試す:
   - `R`: 参照パネルが開く
   - `N`: リネームモードになる
   - `H`: 呼び出し階層が表示される

**デバッグ**:
- ショートカットが動作しない:
  - キーイベントが正しくキャプチャされているか確認
  - VS Codeのコマンドが正しく呼ばれているか確認
  - コンソールでエラーメッセージを確認

---

### テスト4: 変数名でのゴースト

**目的**: 変数名でも同様に動作することを確認

**手順**:
1. `const myVariable = 42;`の`myVariable`にカーソルを置く
2. ゴーストが表示されることを確認
3. ホバーしてガイドを表示
4. **期待されるガイド内容**:
```
[variable] myVariable
D  定義へジャンプ
R  参照を表示
N  名前を変更
T  型定義へジャンプ
```

---

### テスト5: クラス名とメソッド

**目的**: クラス名とメソッド名でゴーストが表示されることを確認

**手順**:
1. `class MyClass`の`MyClass`にカーソルを置く
2. ガイドが表示され、クラス用のショートカットが表示されることを確認
3. `myMethod`でも同様にテスト

**期待される結果**:
```
[class] MyClass
D  定義へジャンプ
R  参照を表示
I  実装へジャンプ
N  名前を変更
M  メンバー一覧
```

---

### テスト6: エラー波線

**目的**: エラー波線でクイックフィックスが表示されることを確認

**手順**:
1. テストファイルに意図的なエラーを追加:
```javascript
const result = undefinedVariable + 1;
```

2. `undefinedVariable`に赤い波線が表示される
3. カーソルをエラー箇所に置く
4. ゴーストが表示される
5. ホバーしてガイドを表示

**期待される結果**:
```
[error] undefinedVariable
F  クイックフィックス
I  詳細情報を表示
G  Google検索
S  Stack Overflow検索
```

6. `F`キーを押してクイックフィックスが開くことを確認

---

### テスト7: import文

**目的**: import文でも動作することを確認

**手順**:
1. ファイルの先頭にimport文を追加:
```javascript
import { useState } from 'react';
```

2. `'react'`の文字列部分にカーソルを置く
3. ゴーストとガイドが表示されることを確認

**期待される結果**:
```
[import] react
D  定義へジャンプ
O  ドキュメントを開く
U  使用箇所を確認
V  バージョンを確認
```

---

### テスト8: カーソル位置の保存と復元

**目的**: ガイドを開いてもカーソル位置が保持されることを確認

**手順**:
1. カーソルを特定の位置（例: 10行目5文字目）に置く
2. ゴーストを表示してガイドを開く
3. `Esc`キーまたはマウスリーブでガイドを閉じる
4. **期待される結果**:
   - カーソルが元の位置（10行目5文字目）に戻る
   - 選択範囲も保持される

---

### テスト9: 複数カーソル

**目的**: 複数カーソルがある場合の動作を確認

**手順**:
1. `Alt+Click`で複数の関数名にカーソルを置く
2. **期待される結果**:
   - 各カーソル位置に個別のゴーストが表示される
   - または、最初のカーソル位置のみにゴーストが表示される（現在の実装）

---

### テスト10: 設定の変更

**目的**: 設定を変更して動作が変わることを確認

**手順**:
1. VS Codeの設定を開く（`Ctrl+,`）
2. "Ghost in the VSC"で検索
3. 設定を変更:
   - `cornerIndicatorSize`: `6`に変更
   - `hoverDelay`: `500`に変更
4. ファイルを再度開く
5. **期待される結果**:
   - 赤い点が大きくなる（6px）
   - ガイド表示までの遅延が500msになる

---

## 🐛 デバッグ方法

### 1. 開発者ツール

**拡張機能ホスト側**:
1. `Help` → `Toggle Developer Tools`
2. Consoleタブでログとエラーを確認

**Webview側**:
1. コマンドパレット（`Ctrl+Shift+P`）を開く
2. `Developer: Open Webview Developer Tools`を実行
3. WebviewのHTML/CSS/JSをデバッグ

### 2. ログ出力

各ファイルに`console.log`を追加してデバッグ:

```typescript
// ghostOverlayManager.ts
console.log('カーソル移動:', position);
console.log('検出されたコンテキスト:', context);

// ghostWebviewProvider.ts
console.log('ゴーストを表示:', word, context);
```

### 3. ブレークポイント

VS Codeのデバッガーを使用:
1. `.ts`ファイルにブレークポイントを設定
2. F5で拡張機能を起動
3. ブレークポイントで停止して変数を検査

---

## 📝 既知の問題と制限

### 現在の制限事項

1. **位置計算の精度**
   - VS Code APIではピクセル単位の正確な位置を取得できない
   - 現在は行高さと文字幅を推定して計算
   - 実際の表示位置がずれる可能性がある

2. **Webviewの制約**
   - Webviewはエディタと完全に統合されていない
   - クリックやドラッグの透過が完全ではない可能性

3. **パフォーマンス**
   - 大きなファイルでは動作が重くなる可能性
   - カーソル移動のたびにコンテキスト検出が走る

### 改善予定

- [ ] 位置計算の精度向上
- [ ] パフォーマンス最適化
- [ ] より多くのコンテキストに対応
- [ ] カスタマイズ可能なショートカットマッピング

---

## ✅ テストチェックリスト

全てのテストが完了したら、以下のチェックリストを確認:

- [ ] テスト1: 基本的なゴースト表示
- [ ] テスト2: ホバーでガイド表示
- [ ] テスト3: キーボードショートカット実行
- [ ] テスト4: 変数名でのゴースト
- [ ] テスト5: クラス名とメソッド
- [ ] テスト6: エラー波線
- [ ] テスト7: import文
- [ ] テスト8: カーソル位置の保存と復元
- [ ] テスト9: 複数カーソル
- [ ] テスト10: 設定の変更

---

## 🎯 次のステップ

テストが完了したら:

1. 実際の開発ワークフローで使用してフィードバックを収集
2. パフォーマンスの問題を特定
3. 追加機能の実装（ファイルエクスプローラー、タブなど）
4. ユーザー向けドキュメントの充実

---

問題が発生した場合は、GitHubでissueを作成してください。


