# Ghost in the VSC - 修正版アプローチ

## 🔧 問題点と修正内容

### 元の問題

報告された問題：
1. ❌ マウスオーバーしても何も起こらない
2. ❌ メソッドをクリックすると新しいウィンドウが開く
3. ❌ 赤い点が4つだけ表示される
4. ❌ ウィンドウを閉じても何度も開く

### 根本原因

**VS Codeの制限**: Webviewパネルをエディタ上に透明なオーバーレイとして表示することは**技術的に不可能**です。

Webviewパネルは：
- 独立したビューとして表示される
- エディタと同じ空間を共有できない
- 別ウィンドウまたは別パネルとして開く

## ✅ 新しいアプローチ

VS Code APIのネイティブ機能を使用した実現可能な方法に変更しました。

### 1. **TextEditorDecoration API**

エディタ内に直接マーカーを表示：

```typescript
// ゴーストマーカーを表示
this.ghostDecorationType = vscode.window.createTextEditorDecorationType({
    before: {
        contentText: '👻',  // ゴースト絵文字
        color: 'rgba(255, 0, 0, 0.6)',
        margin: '0 4px 0 0',
    },
    backgroundColor: 'rgba(255, 200, 0, 0.05)',
    border: '1px solid rgba(255, 200, 0, 0.2)',
});
```

**見え方:**
```javascript
👻 function myTestFunction() {
     ^--- ゴーストマーカー
```

### 2. **QuickPick UI**

ショートカット一覧をネイティブUIで表示：

```
┌─────────────────────────────────────┐
│ 👻 Ghost in the VSC                │
│ "myTestFunction" のショートカット   │
├─────────────────────────────────────┤
│ ⌨ D  定義へジャンプ  (F12と同じ)   │
│ ⌨ R  参照を表示  (Shift+F12と同じ) │
│ ⌨ H  呼び出し階層                   │
│ ⌨ N  名前を変更  (F2と同じ)        │
│ ⌨ P  定義をプレビュー               │
│ ⌨ C  コメントを追加                 │
└─────────────────────────────────────┘
```

### 3. **ステータスバー通知**

ゴーストが表示されたことを知らせる：

```
👻 Ghost: "myTestFunction" でショートカットを使用できます (Ctrl+Shift+Space でガイド表示)
```

---

## 🎯 新しい使い方

### 基本ワークフロー

#### ステップ1: カーソルを置く

関数名や変数名の上にカーソルを置きます。

```javascript
function myTestFunction() {
    //    ^--- ここにカーソル
    console.log('test');
}
```

#### ステップ2: ゴーストマーカーが表示される

```javascript
👻 function myTestFunction() {
   ^--- 自動的に表示
```

ステータスバーにも通知が表示されます：
```
👻 Ghost: "myTestFunction" でショートカットを使用できます
```

#### ステップ3: ガイドを表示

**方法1: キーボードショートカット（推奨）**
```
Ctrl+Shift+Space (Windows/Linux)
Cmd+Shift+Space (Mac)
```

**方法2: コマンドパレットから**
```
Ctrl+Shift+P → "Ghost in the VSC: ガイドを表示"
```

#### ステップ4: ショートカットを選択

QuickPickが表示されるので、矢印キーで選択してEnterを押すか、マウスでクリック。

```
[↑↓で選択]
⌨ D  定義へジャンプ        ← これを選択
⌨ R  参照を表示
⌨ H  呼び出し階層
...
```

#### ステップ5: アクションが実行される

選択したショートカットが即座に実行されます。

---

## 🧪 テスト手順（修正版）

### セットアップ

```bash
# 1. 依存関係をインストール
npm install

# 2. コンパイル
npm run compile

# 3. VS Codeで開く
code .

# 4. F5キーで拡張機能開発ホストを起動
```

---

### テスト1: ゴーストマーカーの表示

**手順:**

1. 拡張機能開発ホストで `test-samples/sample.js` を開く
2. 5行目の `myTestFunction` にカーソルを置く

**期待される結果:**
```
✅ 関数名の左側に 👻 が表示される
✅ 行全体が薄くハイライトされる
✅ ステータスバーに通知が表示される
```

**実際の見え方:**
```javascript
3 | // ========================================
4 | // テスト1: 関数宣言
5 | 👻 function myTestFunction() {
6 |     console.log('Hello, Ghost in the VSC!');
```

---

### テスト2: QuickPickでガイド表示

**手順:**

1. テスト1の状態から続行（カーソルが `myTestFunction` の上）
2. **Ctrl+Shift+Space** を押す（Macは **Cmd+Shift+Space**）

**期待される結果:**
```
✅ QuickPickが画面中央上部に表示される
✅ タイトル: "👻 Ghost in the VSC"
✅ サブタイトル: "myTestFunction" のショートカットを選択 (function)
✅ 以下の項目が表示される:
  - ⌨ D  定義へジャンプ  (F12と同じ)
  - ⌨ R  参照を表示  (Shift+F12と同じ)
  - ⌨ H  呼び出し階層  (Shift+Alt+Hと同じ)
  - ⌨ N  名前を変更  (F2と同じ)
  - ⌨ P  定義をプレビュー  (Alt+F12と同じ)
  - ⌨ C  コメントを追加
```

---

### テスト3: ショートカットの実行

**手順:**

1. テスト2の状態から続行（QuickPickが表示されている）
2. 矢印キー ↓ で「⌨ R  参照を表示」を選択
3. **Enter**を押す

**期待される結果:**
```
✅ 参照パネルが開く
✅ myTestFunction の使用箇所が表示される
✅ 通知メッセージが表示: "✅ ショートカット実行: R (myTestFunction)"
✅ ゴーストマーカーが消える
```

---

### テスト4: 変数でのテスト

**手順:**

1. 12行目の `myVariable` にカーソルを置く
2. Ctrl+Shift+Space を押す

**期待される結果:**
```
✅ QuickPickの内容が変わる:
  - コンテキスト: (variable)
  - ショートカット:
    ⌨ D  定義へジャンプ
    ⌨ R  参照を表示
    ⌨ N  名前を変更
    ⌨ T  型定義へジャンプ
```

---

### テスト5: クラスでのテスト

**手順:**

1. 22行目の `MyTestClass` にカーソルを置く
2. Ctrl+Shift+Space を押す

**期待される結果:**
```
✅ コンテキスト: (class)
✅ ショートカット:
  ⌨ D  定義へジャンプ
  ⌨ R  参照を表示
  ⌨ I  実装へジャンプ
  ⌨ N  名前を変更
  ⌨ M  メンバー一覧
```

---

### テスト6: コメント追加機能

**手順:**

1. `myTestFunction` にカーソルを置く
2. Ctrl+Shift+Space を押す
3. 「⌨ C  コメントを追加」を選択

**期待される結果:**
```
✅ 関数の上にJSDocコメントが自動挿入される:

/**
 * myTestFunction の説明
 */
function myTestFunction() {
    console.log('Hello, Ghost in the VSC!');
}

✅ カーソルが「説明」の部分に移動
✅ そのまま説明を入力できる
```

---

### テスト7: 有効/無効の切り替え

**手順:**

1. **Ctrl+Shift+G** を押す（Macは **Cmd+Shift+G**）

**期待される結果:**
```
✅ 通知が表示: "Ghost in the VSC: 無効"
✅ ゴーストマーカーが表示されなくなる
```

2. もう一度 **Ctrl+Shift+G** を押す

**期待される結果:**
```
✅ 通知が表示: "Ghost in the VSC: 有効"
✅ ゴーストマーカーが再び表示される
```

---

## 📊 新旧比較

| 機能 | 旧実装（Webview） | 新実装（Native API） |
|------|-------------------|---------------------|
| **オーバーレイ表示** | ❌ 別ウィンドウで開く | ✅ エディタ内に表示 |
| **ゴーストインジケーター** | ❌ 表示されない | ✅ 👻マーカーで表示 |
| **ガイド表示** | ❌ 新しいウィンドウ | ✅ QuickPickで表示 |
| **マウスホバー** | ❌ 動作しない | ⚠️ 不要（キーボード操作） |
| **パフォーマンス** | ❌ 重い | ✅ 軽量 |
| **統合感** | ❌ 違和感あり | ✅ VS Codeネイティブ |

---

## 🎨 カスタマイズ

### マーカーの見た目を変更

設定で `cornerIndicatorSize` を変更すると、マーカーの表示が変わります：

```json
// settings.json
{
  "ghostInTheVSC.cornerIndicatorSize": 4,  // デフォルト: •
  "ghostInTheVSC.cornerIndicatorSize": 8   // 大きい: 👻
}
```

---

## ⚡ キーボードショートカット一覧

| キー | 機能 |
|------|------|
| `Ctrl+Shift+Space` | ガイドを表示 |
| `Ctrl+Shift+G` | 有効/無効を切り替え |

### QuickPick内での操作

| キー | 動作 |
|------|------|
| `↑↓` | 項目を選択 |
| `Enter` | 実行 |
| `Esc` | キャンセル |
| マウスクリック | 実行 |

---

## 💡 利点と制限

### ✅ 利点

1. **エディタと完全統合**: VS CodeのネイティブUIを使用
2. **パフォーマンス**: 軽量で高速
3. **安定性**: Webviewの問題を回避
4. **メンテナンス性**: シンプルなコード
5. **一貫性**: VS Codeの他の機能と同じUX

### ⚠️ 制限（元の構想との違い）

1. **マウスオーバー**: 実装困難なため、キーボード操作に変更
2. **ホイールスクロール**: QuickPickでは不要
3. **透明オーバーレイ**: 技術的に不可能なため、デコレーションを使用
4. **四隅の赤い点**: 単一の👻マーカーに変更

### 🎯 実現できている主要機能

- ✅ カーソル位置でのコンテキスト検出
- ✅ 視覚的なインジケーター表示
- ✅ ショートカット一覧の表示
- ✅ ワンクリックでのアクション実行
- ✅ コンテキスト別のショートカット
- ✅ カスタマイズ可能な設定

---

## 🚀 次のステップ

### すぐに試す

```bash
# コンパイル
npm run compile

# F5で起動
# test-samples/sample.js を開いてテスト
```

### フィードバック

このアプローチについて：
- 使いやすいですか？
- 元の構想と比べてどうですか？
- 改善点はありますか？

---

## 🔮 将来的な改善案

### 検討中の機能

1. **Hover Provider統合**
   - 既存のホバー情報に統合
   - クリックでQuickPickを開く

2. **コンテキストメニュー**
   - 右クリックメニューにショートカット追加
   - より直感的なアクセス

3. **CodeLens統合**
   - 関数の上にレンズとして表示
   - クリックでアクション実行

4. **キーマップのカスタマイズ**
   - ユーザーが独自のショートカットを定義
   - 設定UIの提供

---

**この新しいアプローチは、VS Codeの制限内で実現可能な最良の方法です。**

質問や改善案があれば、ぜひフィードバックをお願いします！





