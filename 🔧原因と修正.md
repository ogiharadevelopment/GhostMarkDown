# 🔧 原因と修正 - ホバータイムアウト問題

## 🔍 ログから判明した原因

### 問題の症状

**ホバーしていても文字が入る時と入らない時がある**

### ログの分析

#### ケースA: 成功（文字が入らない）

```
[Ghost] 🔵 isHovering = true に設定
[Ghost] ⌨️  キー入力: "R", active=true, isHovering=true ← true!
[Ghost] 🚀 ショートカット実行
```

#### ケースB: 失敗（文字が入る）

```
[Ghost] 🔵 isHovering = true に設定
[Ghost] ⏱️  ホバータイムアウト: isHovering = false に設定（マウスリーブ検出）
                                            ↑
                        0.5秒後に自動的にfalseになる
[Ghost] ⌨️  キー入力: "R", active=true, isHovering=false ← false!
[Ghost] 🔵 キー入力: isHovering=false（👻にホバーしていない） - 通常の入力として処理
```

---

## 🎯 根本原因

**0.5秒のタイムアウトが早すぎる**

```typescript
// provideHover 内で設定されていたコード
this.hoverLeaveTimeout = setTimeout(() => {
    this.hoverState.isHovering = false;
}, 500); // ← 0.5秒後に自動的にfalse
```

### タイミング図

```
[0秒] ホバー → isHovering = true
[0.5秒] タイムアウト → isHovering = false
[0.6秒] ユーザーがRキーを押す → isHovering = false なので文字が入力される
```

ユーザーがホバーしてからキーを押すまでに0.5秒以上かかると、`isHovering`が勝手に`false`になってしまいます。

---

## ✅ 実施した修正

### 修正1: タイムアウトを削除

```typescript
// 修正前
this.hoverLeaveTimeout = setTimeout(() => {
    this.hoverState.isHovering = false;
}, 500);

// 修正後
// タイムアウトは使用しない
if (this.hoverLeaveTimeout) {
    clearTimeout(this.hoverLeaveTimeout);
    this.hoverLeaveTimeout = undefined;
}
```

### 修正2: カーソル移動でホバー終了を検出

```typescript
// カーソルが大きく移動したらホバー終了
onDidChangeTextEditorSelection((e) => {
    if (this.hoverState.isHovering) {
        const currentPos = e.selections[0].active;
        if (currentPos.line !== this.hoverState.position.line || 
            Math.abs(currentPos.character - this.hoverState.position.character) > 5) {
            console.log('[Ghost] 🔵 カーソル移動検出: isHovering = false');
            this.hoverState.isHovering = false;
        }
    }
});
```

### 修正3: 非ショートカットキー入力でホバー終了

```typescript
// ショートカットキーでない場合
if (非ショートカットキー) {
    // ホバー状態を解除
    this.hoverState.isHovering = false;
    // 通常の入力として処理
    return normalInput;
}
```

---

## 🎯 新しい動作

### ホバー状態の管理

```
1. 👻にホバー
   → isHovering = true
   → タイムアウトなし（無期限に維持）

2. マウスリーブ（以下のいずれかで検出）
   a) カーソルが大きく移動
   b) 非ショートカットキーを入力
   c) 別の場所をクリック
   → isHovering = false

3. キー入力時のチェック
   active && isHovering の両方がtrue
   → ショートカット実行
```

---

## 🧪 テスト手順

### ステップ1: コンパイルと起動

```bash
npm run compile
code .
# F5キーで起動
# Ctrl+Shift+I で開発者ツール
```

### ステップ2: 時間をかけてテスト

```
1. 関数をクリック → 👻表示
2. 👻にホバー → ガイド表示
3. ゆっくり考える（2秒待つ）
4. Rキーを押す
```

**期待される結果:**
- ✅ 参照パネルが開く
- ✅ 「R」は入力されない
- ✅ 何秒待っても`isHovering`は`true`のまま

**ログ:**
```
[Ghost] 🔵 isHovering = true に設定
（タイムアウトログは出ない）
[Ghost] ⌨️  キー入力: "R", active=true, isHovering=true
[Ghost] 🚀 ショートカット実行
```

---

### ステップ3: マウスリーブのテスト

```
1. 関数をクリック → 👻表示
2. 👻にホバー → ガイド表示
3. マウスを大きく動かす（別の行へ）
4. Rキーを押す
```

**期待される結果:**
- ✅ 「R」が入力される
- ✅ ショートカットは実行されない

**ログ:**
```
[Ghost] 🔵 isHovering = true に設定
[Ghost] 🔵 カーソル移動検出: isHovering = false に設定
[Ghost] ⌨️  キー入力: "R", active=true, isHovering=false
[Ghost] 🔵 通常の入力として処理
```

---

### ステップ4: 非ショートカットキーのテスト

```
1. 関数をクリック → 👻表示
2. 👻にホバー → ガイド表示
3. Aキーを押す（ショートカットではない）
4. Bキーを押す
```

**期待される結果:**
- ✅ 「A」が入力される
- ✅ 「B」が入力される
- ✅ `isHovering = false`になる

**ログ:**
```
[Ghost] 🔵 isHovering = true に設定
[Ghost] ⌨️  キー入力: "A", active=true, isHovering=true
[Ghost] 🔵 非ショートカットキー入力: isHovering = false に設定
（Aが入力される）
[Ghost] ⌨️  キー入力: "B", active=true, isHovering=false
（Bが入力される）
```

---

## 📊 修正のまとめ

| 問題 | 原因 | 修正 |
|------|------|------|
| **タイムアウトで文字が入る** | 0.5秒で自動的にfalse | タイムアウト削除 |
| **ホバー終了の検出** | マウスリーブが検出できない | カーソル移動で検出 |
| **非ショートカットキー** | falseにならない | キー入力時にfalseに設定 |

---

## 🎯 期待される動作

### 👻にホバー中（何秒待ってもOK）

```
ホバー → 2秒待つ → キー押す
→ isHovering = true のまま
→ ショートカット実行 ✅
```

### マウスを離した後

```
ホバー → マウスを離す → キー押す
→ カーソル移動またはタイム経過で isHovering = false
→ 通常の文字入力 ✅
```

### 非ショートカットキー

```
ホバー → Aキー押す
→ isHovering = false に設定
→ 「A」が入力される ✅
```

---

## 🚀 今すぐテスト

```bash
npm run compile
code .
# F5で起動
# Ctrl+Shift+I で開発者ツール
```

重要な確認ポイント：

1. ✅ ホバー後、何秒待ってもショートカットが発動するか
2. ✅ `⏱️ ホバータイムアウト`のログが出ないか
3. ✅ キー入力時に`isHovering=true`が維持されているか

---

試してみて、もう一度ログを確認してください！

今回は **`⏱️ ホバータイムアウト`** のログが出なくなっているはずです。😊







