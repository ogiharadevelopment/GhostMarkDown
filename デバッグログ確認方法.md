# 🔍 デバッグログの確認方法

## 📋 ログの確認手順

### 方法1: 開発者ツール（拡張機能ホスト側）⭐ おすすめ

1. **拡張機能開発ホストのウィンドウ**で作業

2. **`Ctrl+Shift+I`** を押す（Macは`Cmd+Option+I`）

3. **開発者ツール**が開く

4. **Console**タブをクリック

5. ログが表示される：
```
[Ghost] 🟢 クリック検出: word="myTestFunction", context="function", line=5, active=true
[Ghost] 👆 ホバー検出 #1: line=5, char=15, active=true
[Ghost] ✅ ホバー情報を表示: word="myTestFunction", context="function"
[Ghost] ⌨️  キー入力: "R", active=true, word="myTestFunction"
[Ghost] 🚀 ショートカット実行: key="R", label="参照を表示"
```

### 方法2: 出力パネル

1. **メニューバー** → **表示** → **出力**

2. または **`Ctrl+Shift+U`** を押す

3. 右側のドロップダウンで **"拡張機能ホスト"** を選択

4. ログが表示される

---

## 🧪 テストシナリオ

### シナリオ1: 1回目のホバー（正常動作を確認）

#### 操作手順
1. `test-samples/sample.js` を開く
2. 関数名 `myTestFunction` を**クリック**
3. 関数名に**マウスホバー**
4. **Rキー**を押す

#### 期待されるログ
```
[Ghost] 🟢 クリック検出: word="myTestFunction", context="function", line=5, active=true
[Ghost] 👆 ホバー検出 #1: line=5, char=15, active=true
[Ghost] 📏 ホバー: クリック位置との距離 distance=0 (クリック行=5)
[Ghost] ✅ ホバー情報を表示: word="myTestFunction", context="function"
[Ghost] ⌨️  キー入力: "R", active=true, word="myTestFunction"
[Ghost] 🔍 キー入力チェック: key="R", ショートカット=見つかった
[Ghost] 🚀 ショートカット実行: key="R", label="参照を表示"
[Ghost] 🧹 ホバー状態をクリア（キー入力を防ぐため）
[Ghost] 🗑️  ホバー状態をクリア: active=false に設定
[Ghost] ✅ ショートカット実行完了 - return（文字入力を防ぐ）
```

---

### シナリオ2: 2回目のホバー（問題の再現）

#### 操作手順
1. 関数名 `myTestFunction` を**クリック**
2. 関数名に**マウスホバー**
3. **マウスを離す**（マウスリーブ）
4. 再度、関数名に**マウスホバー**
5. **Rキー**を押す

#### 確認すべきログのポイント

##### ✅ 正常な場合
```
[Ghost] 🟢 クリック検出: word="myTestFunction", context="function", line=5, active=true
[Ghost] 👆 ホバー検出 #1: line=5, char=15, active=true
[Ghost] ✅ ホバー情報を表示: word="myTestFunction", context="function"
（マウスリーブ - ログなし）
[Ghost] 👆 ホバー検出 #2: line=5, char=15, active=true  ← 2回目
[Ghost] ✅ ホバー情報を表示: word="myTestFunction", context="function"
[Ghost] ⌨️  キー入力: "R", active=true, word="myTestFunction"  ← active=true
[Ghost] 🚀 ショートカット実行: key="R", label="参照を表示"
[Ghost] ✅ ショートカット実行完了 - return（文字入力を防ぐ）
```

##### ❌ 問題がある場合（文字が挿入される）
```
[Ghost] 🟢 クリック検出: word="myTestFunction", context="function", line=5, active=true
[Ghost] 👆 ホバー検出 #1: line=5, char=15, active=true
[Ghost] ✅ ホバー情報を表示: word="myTestFunction", context="function"
（マウスリーブ - 何らかの理由でクリアされる？）
[Ghost] 🗑️  ホバー状態をクリア: active=false に設定  ← ここが問題
[Ghost] 👆 ホバー検出 #2: line=5, char=15, active=false  ← active=false!
[Ghost] ⚪ ホバー: active=false - ホバー情報を表示しない
[Ghost] ⌨️  キー入力: "R", active=false, word=""  ← active=false!
[Ghost] 🔵 キー入力: active=false - 通常の入力として処理  ← 文字が挿入される
```

---

## 🔍 ログの読み方

### ログの記号

| 記号 | 意味 |
|------|------|
| 🟢 | クリック検出（ゴースト有効化） |
| 👆 | ホバー検出 |
| ✅ | ホバー情報表示 |
| ⌨️  | キー入力 |
| 🚀 | ショートカット実行 |
| 🧹 | ホバー状態をクリア（意図的） |
| 🗑️  | ホバー状態をクリア（実行） |
| 🔵 | 通常の入力として処理 |
| ⚪ | 処理をスキップ |
| 🔴 | エラーまたは無効化 |
| ⏰ | タイムアウト |
| 📏 | 距離計算 |
| 🔍 | チェック処理 |

### 重要なログ項目

#### 1. `active` の値
```
active=true  → ゴースト状態がアクティブ（キー入力が処理される）
active=false → ゴースト状態が非アクティブ（通常の入力）
```

#### 2. `hoverCount`
```
#1 → 1回目のホバー
#2 → 2回目のホバー
```

#### 3. `distance`
```
distance=0 → ホバー位置がクリック位置と同じ行
distance=1 → 1行離れている
distance=2 → 2行以上離れている（ホバー情報を表示しない）
```

#### 4. `word` の値
```
word="myTestFunction" → ゴースト状態に関数名が保存されている
word="" → ゴースト状態がクリアされている
```

---

## 📝 問題の特定方法

### チェック1: 2回目のホバー時の`active`の値

```
[Ghost] 👆 ホバー検出 #2: line=5, char=15, active=?
                                           ↑
                                      ここを確認
```

- `active=true` → 正常（ゴースト状態が保持されている）
- `active=false` → 問題（ゴースト状態がクリアされている）

### チェック2: マウスリーブ時に`clearHoverState`が呼ばれているか

```
（マウスリーブの前後でログを確認）
[Ghost] ✅ ホバー情報を表示
（マウスリーブ）
[Ghost] 🗑️  ホバー状態をクリア  ← これがあると問題
[Ghost] 👆 ホバー検出 #2
```

- ログがない → 正常（状態が保持されている）
- ログがある → 問題（マウスリーブ時に状態がクリアされている）

### チェック3: キー入力時の状態

```
[Ghost] ⌨️  キー入力: "R", active=?, word="?"
                           ↑       ↑
                      ここを確認
```

- `active=true, word="myTestFunction"` → 正常
- `active=false, word=""` → 問題

---

## 🎯 デバッグの流れ

### ステップ1: ログを有効化

```bash
npm run compile
code .
# F5キーで起動
```

### ステップ2: 開発者ツールを開く

拡張機能開発ホストで `Ctrl+Shift+I` → Console タブ

### ステップ3: フィルタリング

Console タブの検索ボックスに `[Ghost]` と入力すると、Ghost関連のログのみ表示されます。

### ステップ4: 問題を再現

1. 関数をクリック
2. ホバー → キー押す（1回目）
3. マウスリーブ
4. ホバー → キー押す（2回目） ← ここで問題発生

### ステップ5: ログを確認

上記の「問題の特定方法」に従ってログを確認します。

---

## 💡 追加のデバッグ方法

### ブレークポイントの設定

1. VS Codeで`src/hoverShortcutProvider.ts`を開く

2. 以下の行にブレークポイントを設定：
   - `handleKeyPress`の最初の行
   - `provideHover`の最初の行
   - `clearHoverState`の最初の行

3. F5で起動

4. 問題を再現すると、ブレークポイントで停止

5. 変数の値を確認：
   - `this.hoverState.active`
   - `this.hoverState.word`
   - `this.hoverCount`

---

## 📊 ログのコピー方法

1. Console タブでログを選択

2. 右クリック → **Copy** または **Copy All**

3. テキストファイルに貼り付けて保存

4. 問題のログを共有してください

---

## 🐛 既知の問題パターン

### パターン1: マウスリーブ時に状態がクリアされる

**症状:**
```
[Ghost] 🗑️  ホバー状態をクリア: active=false に設定
```
がマウスリーブ時に出力される

**原因:** 
- タイムアウト処理
- カーソル移動検出
- 他のイベントハンドラー

### パターン2: ホバー検出時にactive=false

**症状:**
```
[Ghost] 👆 ホバー検出 #2: line=5, char=15, active=false
```

**原因:**
- パターン1でクリアされた状態のまま
- クリック検出が再度発生していない

---

## 🎉 成功パターン

正常に動作する場合のログ：

```
[Ghost] 🟢 クリック検出: word="myTestFunction", context="function", line=5, active=true
[Ghost] 👆 ホバー検出 #1: line=5, char=15, active=true
[Ghost] ✅ ホバー情報を表示
[Ghost] ⌨️  キー入力: "R", active=true, word="myTestFunction"
[Ghost] 🚀 ショートカット実行
[Ghost] 🗑️  ホバー状態をクリア: active=false に設定
[Ghost] ✅ ショートカット実行完了 - return（文字入力を防ぐ）
```

---

**ログを確認して、何が違うか報告してください！**






